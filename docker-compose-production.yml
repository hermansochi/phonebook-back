version: "3.9"
services:
    api:
        image: ${REGISTRY}/herman-team-api:${IMAGE_TAG}
        networks:
            - traefik-public
            - default
        deploy:
            labels:
                - traefik.enable=true
                - traefik.docker.network=traefik-public
                - traefik.constraint-label=traefik-public
                - traefik.http.routers.api-http.rule=Host(`api.herman.team`)
                - traefik.http.routers.api-http.entrypoints=http
                - traefik.http.routers.api-http.middlewares=https-redirect
                - traefik.http.routers.api-https.rule=Host(`api.herman.team`)
                - traefik.http.routers.api-https.entrypoints=https
                - traefik.http.routers.api-https.tls=true
                - traefik.http.routers.api-https.tls.certresolver=le
                - traefik.http.services.api.loadbalancer.server.port=80
            mode: replicated
            replicas: 1
            update_config:
                parallelism: 1
                delay: 5s
            placement:
                constraints: 
                    - node.labels.back.manager == true

    php-fpm:
        image: ${REGISTRY}/php-fpm:${IMAGE_TAG}
        deploy:
            mode: replicated
            replicas: 1
            update_config:
                parallelism: 1
                delay: 5s
            placement:
                constraints: 
                    - node.labels.back.manager == true

    appinit:
        image: ${REGISTRY}/appinit:${IMAGE_TAG}
        command: sh -c 'wait-for-it api-postgres:5432 -t 60 && php artisan migrate:fresh && php artisan github:get && php artisan route:cache && php artisan config:cache && php artisan schedule:work'
        deploy:
            restart_policy:
                condition: on-failure
                delay: 60s
                max_attempts: 5
                window: 120s
            placement:
                constraints: 
                    - node.labels.back.manager == true

    api-postgres:
        image: postgres:15.1-alpine
        environment:
            POSTGRES_USER: app
            POSTGRES_PASSWORD_FILE: run/secrets/api_db_password
            POSTGRES_DB: app
            POSTGRES_HOST_AUTH_METHOD: trust
        secrets:
            - api_db_password
        volumes:
            - api-postgres:/var/lib/postgresql/data
        deploy:
            endpoint_mode: dnsrr
            placement:
                constraints: 
                    - node.labels.back.manager == true

    minio:
        image: minio/minio:RELEASE.2022-10-21T22-37-48Z
        command: server --console-address ":9001" /data
        environment:
            MINIO_ROOT_USER: local
            MINIO_ROOT_PASSWORD: secret123456
            MINIO_BROWSER_REDIRECT_URL: https://console.storage.herman.team
        volumes:
            - minio-storage:/data
        networks:
            - traefik-public
            - default
        deploy:
            labels:
                - traefik.enable=true
                - traefik.docker.network=traefik-public
                # Console
                - traefik.http.routers.storage-console.rule=Host(`console.storage.herman.team`)
                - traefik.http.routers.storage-console.entrypoints=https
                - traefik.http.routers.storage-console.service=storage-console
                - traefik.http.services.storage-console.loadbalancer.server.port=9001
                - traefik.http.routers.storage-console.tls=true
                - traefik.http.routers.storage-console.tls.certResolver=letsEncrypt
                # APi
                - traefik.http.routers.storage.rule=Host(`storage.herman.team`)
                - traefik.http.routers.storage.entrypoints=https
                - traefik.http.routers.storage.service=storage
                - traefik.http.services.storage.loadbalancer.server.port=9000
                - traefik.http.routers.storage.tls=true
                - traefik.http.routers.storage.tls.certResolver=letsEncrypt
            mode: replicated
            replicas: 1
            update_config:
                parallelism: 1
                delay: 5s
            placement:
                constraints: 
                    - node.labels.back.manager == true
        healthcheck:
            test: ["CMD", "curl", "-f", "http://127.0.0.1:9000/minio/health/live"]
            interval: 30s
            timeout: 20s
            retries: 3

    mc-service:
        image: minio/mc
        entrypoint: /bin/sh -c "/usr/bin/mc alias set myminio http://minio:9000 local secret123456 && /usr/bin/mc mb myminio/pet && /usr/bin/mc anonymous set download myminio/pet"
        deploy:
            placement:
                constraints: 
                    - node.labels.back.manager == true


secrets:
    api_db_password:
        file: ./secrets/api_db_password

volumes:
    api-postgres:
    minio-storage:

networks:
    traefik-public:
        external: true